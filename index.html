<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>O IMPOSTOR üî™ VOICE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0f0f1a; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-container { background: #1c1c2d; width: 95%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.7); border: 2px solid #3b3b55; position: relative; box-sizing: border-box; }
        .active { display: block !important; }
        .screen { display: none; }
        
        /* Painel de Configura√ß√µes */
        #settings-panel { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; background: #2a2a40; padding: 20px; border-radius: 15px; border: 2px solid #7289da; z-index: 100; box-shadow: 0 0 50px #000; }
        .close-settings { float: right; cursor: pointer; color: #ff4757; font-weight: bold; }
        
        .config-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; background: none; border: none; padding: 0; width: auto; margin: 0; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; background: #2a2a40; color: #fff; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; background: #7289da; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        #player-counter { background: #34495e; padding: 5px 15px; border-radius: 20px; font-size: 14px; display: inline-block; margin-bottom: 10px; }
        #timer-display { font-size: 28px; text-align: center; color: #f39c12; font-weight: bold; }
        #status-msg { text-align: center; color: #43b581; margin-bottom: 5px; font-weight: bold; }
        #chat-box { height: 180px; overflow-y: auto; background: #0f0f1a; padding: 10px; border-radius: 10px; margin: 10px 0; border: 1px solid #3b3b55; }
        .msg { margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px; font-size: 13px; }
        
        .switch { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; background: #1c1c2d; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="game-container">
        <button class="config-btn" onclick="toggleSettings()">‚öôÔ∏è</button>

        <div id="settings-panel">
            <span class="close-settings" onclick="toggleSettings()">X</span>
            <h3 style="margin-top:0">Configura√ß√µes</h3>
            <div class="switch">
                <span>Mutar √Åudio üîá</span>
                <input type="checkbox" id="mute-toggle" style="width: auto;" onchange="updateMute()">
            </div>
            <p style="font-size: 10px; color: #888;">Se mutar, voc√™ n√£o ouvir√° ningu√©m e seu mic ser√° desligado.</p>
            <button onclick="toggleSettings()" style="background: #43b581;">SALVAR</button>
        </div>

        <div id="setup-screen" class="screen active">
            <h1 style="text-align: center; color: #e74c3c; margin: 0 0 10px 0;">O IMPOSTOR üî™</h1>
            <input type="text" id="player-name" placeholder="Seu Nome" maxlength="15">
            
            <div style="background: #2a2a40; padding: 10px; border-radius: 10px;">
                <label style="font-size: 11px; color: #888;">JOGADORES:</label>
                <select id="max-players"><option value="2">2 (X1)</option><option value="3" selected>3 Jogadores</option></select>
                <label style="font-size: 11px; color: #888;">MODO:</label>
                <select id="game-mode"><option value="turno">TURNO (20s)</option><option value="livre">CHAT LIVRE</option></select>
            </div>

            <button onclick="setupHost()" style="background:#43b581">CRIAR SALA</button>
            <input type="text" id="join-id" placeholder="ID da Sala">
            <input type="password" id="join-pass" placeholder="Senha">
            <button onclick="joinRoom()">ENTRAR NO JOGO</button>
        </div>

        <div id="game-screen" class="screen">
            <center><div id="player-counter">Aguardando: 1/--</div></center>
            <div id="timer-display">--</div>
            <div id="status-msg">Conectando...</div>
            
            <div id="chat-box"></div>
            
            <div style="display:flex; gap:5px">
                <input type="text" id="chat-input" placeholder="Pista...">
                <button onclick="sendMsg()" style="width:70px; margin:8px 0; background:#f39c12">OK</button>
            </div>

            <button id="btn-guess" style="display:none; background:#e74c3c" onclick="impostorGuess()">ADIVINHAR üí°</button>
            <button id="btn-vote" style="background:#f1c40f; color:#000" onclick="openVote()">VOTAR ‚öñÔ∏è</button>
            <button id="copy-btn" style="background: #555; font-size: 10px;" onclick="copyInviteLink()">üìã LINK</button>
        </div>
    </div>

<script>
    let peer = new Peer(), conn, myId, isHost = false, amIImpostor = false;
    let players = [], maxPlayers = 3, gameMode = "turno", turnIndex = 0;
    let words = ["TABLET", "CAF√â", "TELEVIS√ÉO", "PIZZA", "CELULAR", "GELADEIRA", "FOGO", "XBOX", "BOLO"];
    let currentWord = "", turnTimer, allPlayers = [], myStream, isMuted = false;

    peer.on('open', id => {
        myId = id;
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('room')) document.getElementById('join-id').value = urlParams.get('room');
    });

    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    function updateMute() {
        isMuted = document.getElementById('mute-toggle').checked;
        if(myStream) {
            myStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
        }
    }

    async function initVoice() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            updateMute();
            peer.on('call', call => {
                call.answer(myStream);
                call.on('stream', remoteStream => {
                    const audio = new Audio(); audio.srcObject = remoteStream;
                    if(!isMuted) audio.play();
                });
            });
        } catch (e) { console.log("Sem mic"); }
    }

    async function setupHost() {
        const p = prompt("Senha:"); if(!p) return;
        await initVoice(); isHost = true;
        maxPlayers = parseInt(document.getElementById('max-players').value);
        gameMode = document.getElementById('game-mode').value;
        showScreen('game-screen');
        updateCounter();

        peer.on('connection', c => {
            c.on('data', data => {
                if(data.type === 'auth') {
                    players.push({id: c.peer, name: data.name, conn: c});
                    c.send({type: 'auth_ok', max: maxPlayers, mode: gameMode});
                    peer.call(c.peer, myStream);
                    updateCounter();
                    broadcastCounter();
                    if(players.length === maxPlayers - 1) startGame();
                }
                if(data.type === 'chat') handleChat(data);
                if(data.type === 'guess') checkGuess(data.word, data.name);
            });
        });
    }

    async function joinRoom() {
        await initVoice();
        conn = peer.connect(document.getElementById('join-id').value);
        conn.on('open', () => conn.send({type: 'auth', name: document.getElementById('player-name').value, pass: document.getElementById('join-pass').value}));
        conn.on('data', data => {
            if(data.type === 'auth_ok') { maxPlayers = data.max; showScreen('game-screen'); }
            if(data.type === 'counter') updateCounter(data.val);
            if(data.type === 'start') handleStart(data);
            if(data.type === 'chat') addMsg(data.name, data.text);
            if(data.type === 'turn') updateTurnUI(data.name);
            if(data.type === 'end') { alert(data.msg); location.reload(); }
        });
    }

    function updateCounter(val) {
        const count = val || (players.length + 1);
        document.getElementById('player-counter').innerText = `Jogadores: ${count}/${maxPlayers}`;
    }

    function broadcastCounter() {
        players.forEach(p => p.conn.send({type: 'counter', val: players.length + 1}));
    }

    function startGame() {
        currentWord = words[Math.floor(Math.random()*words.length)];
        const impIdx = Math.floor(Math.random() * maxPlayers);
        allPlayers = [{id: myId, name: document.getElementById('player-name').value, isImp: (impIdx === 0)}, ...players.map((p, i) => ({id: p.id, name: p.name, isImp: (impIdx === i+1)}))];
        players.forEach((p, i) => p.conn.send({type: 'start', isImp: (impIdx === i+1), word: currentWord, all: allPlayers}));
        handleStart({isImp: (impIdx === 0), word: currentWord, all: allPlayers});
    }

    function handleStart(data) {
        amIImpostor = data.isImp; currentWord = data.word; allPlayers = data.all;
        document.getElementById('status-msg').innerText = amIImpostor ? "VOC√ä √â O IMPOSTOR!" : "PALAVRA: " + currentWord;
        document.getElementById('btn-guess').style.display = amIImpostor ? "block" : "none";
        if(gameMode === 'turno') { turnIndex = 0; if(isHost) startTurn(); }
    }

    function startTurn() {
        const p = allPlayers[turnIndex];
        players.forEach(c => c.conn.send({type: 'turn', name: p.name}));
        updateTurnUI(p.name);
        let time = 20; clearInterval(turnTimer);
        turnTimer = setInterval(() => {
            time--; document.getElementById('timer-display').innerText = time;
            if(time <= 0) nextTurn();
        }, 1000);
    }

    function nextTurn() { turnIndex = (turnIndex+1)%maxPlayers; startTurn(); }

    function updateTurnUI(name) {
        const isMe = (name === document.getElementById('player-name').value);
        document.getElementById('status-msg').innerText = isMe ? "SUA VEZ! üé§" : "Vez de: " + name;
    }

    function sendMsg() {
        const i = document.getElementById('chat-input'); if(!i.value) return;
        const n = document.getElementById('player-name').value;
        if(isHost) handleChat({name:n, text:i.value}); else conn.send({type: 'chat', name:n, text:i.value});
        i.value = "";
    }

    function handleChat(data) {
        addMsg(data.name, data.text);
        if(isHost) { players.forEach(p => p.conn.send({type: 'chat', name:data.name, text:data.text})); if(gameMode==='turno') nextTurn(); }
    }

    function addMsg(n, t) { const b = document.getElementById('chat-box'); b.innerHTML += `<div class="msg"><b>${n}:</b> ${t}</div>`; b.scrollTop = b.scrollHeight; }
    function showScreen(s) { document.querySelectorAll('.screen').forEach(d => d.classList.remove('active')); document.getElementById(s).classList.add('active'); }
    function copyInviteLink() { navigator.clipboard.writeText(window.location.href.split('?')[0] + "?room=" + myId); alert("Link copiado!"); }

    function checkGuess(g, name) {
        const win = g.toUpperCase().includes(currentWord);
        const msg = win ? `IMPOSTOR GANHOU! Era ${currentWord}` : `IMPOSTOR ERROU! Era ${currentWord}`;
        if(isHost) players.forEach(p => p.conn.send({type: 'end', msg}));
        alert(msg); location.reload();
    }
    
    function impostorGuess() {
        const g = prompt("Palavra:"); if(g) { if(isHost) checkGuess(g, "Host"); else conn.send({type: 'guess', word: g, name: document.getElementById('player-name').value}); }
    }

    function openVote() {
        let t = prompt("Nome para expulsar:");
        if(t && isHost) handleVote(t); else if(t) conn.send({type: 'vote_cast', target: t});
    }
</script>
</body>
</html>
