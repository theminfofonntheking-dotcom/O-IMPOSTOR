<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>O IMPOSTOR üî™</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0f0f1a; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-container { background: #1c1c2d; width: 95%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.7); border: 2px solid #3b3b55; position: relative; box-sizing: border-box; }
        .active { display: block !important; }
        .screen { display: none; }
        
        /* Letreiro de Aviso */
        #marquee-container { width: 100%; overflow: hidden; background: #e74c3c; color: white; position: absolute; top: 0; left: 0; border-radius: 20px 20px 0 0; display: none; padding: 5px 0; z-index: 10; }
        .marquee-text { display: inline-block; white-space: nowrap; animation: marquee 8s linear infinite; font-weight: bold; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; background: #2a2a40; color: #fff; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; background: #7289da; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        #timer-display { font-size: 28px; text-align: center; color: #f39c12; font-weight: bold; }
        #status-msg { text-align: center; color: #43b581; margin-bottom: 5px; font-weight: bold; }
        #chat-box { height: 220px; overflow-y: auto; background: #0f0f1a; padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid #3b3b55; }
        .msg { margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px; word-wrap: break-word; }
        .role-area { padding: 12px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 5px; }
        
        .action-btns { display: flex; gap: 5px; margin-bottom: 5px; }
        button.imp-btn { background: #e74c3c; flex: 1; font-size: 12px; }
        button.vote-btn { background: #f1c40f; color: #000; flex: 1; font-size: 12px; }
        #room-info { background: #2a2a40; padding: 10px; border-radius: 10px; font-size: 12px; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="marquee-container"><div class="marquee-text" id="marquee-val">JOGADOR DEMORANDO! ANDA LOGO!</div></div>

        <div id="setup-screen" class="screen active">
            <h1 style="text-align: center; color: #e74c3c; margin: 0 0 10px 0;">O IMPOSTOR üî™</h1>
            <input type="text" id="player-name" placeholder="Seu Nome" maxlength="20">
            
            <div style="background: #2a2a40; padding: 10px; border-radius: 10px; margin: 5px 0;">
                <label style="font-size: 11px; color: #888;">N¬∫ DE JOGADORES:</label>
                <select id="max-players">
                    <option value="2">2 Jogadores (X1)</option>
                    <option value="3" selected>3 Jogadores</option>
                    <option value="4">4 Jogadores</option>
                </select>
                <label style="font-size: 11px; color: #888;">MODO:</label>
                <select id="game-mode">
                    <option value="turno">TURNO (20s)</option>
                    <option value="livre">CHAT LIVRE</option>
                </select>
            </div>

            <button onclick="setupHost()" style="background:#43b581">CRIAR SALA</button>
            <div style="text-align: center; margin: 10px 0; font-size: 12px;">OU</div>
            <input type="text" id="join-id" placeholder="ID da Sala">
            <input type="password" id="join-pass" placeholder="Senha">
            <button onclick="joinRoom()">ENTRAR NO JOGO</button>
        </div>

        <div id="game-screen" class="screen">
            <div id="room-info" style="display:none;">
                ID: <span id="display-id">---</span> 
                <button onclick="copyInviteLink()" style="padding: 5px; margin: 0; font-size: 10px; background: #7289da;">üìã COPIAR LINK</button>
            </div>
            
            <div id="timer-display">--</div>
            <div id="status-msg">Aguardando jogadores...</div>
            <div id="role-display" class="role-area" style="background: #34495e;">-</div>
            
            <div class="action-btns">
                <button id="btn-guess" class="imp-btn" onclick="impostorGuess()" style="display:none;">ADIVINHAR üí°</button>
                <button id="btn-vote" class="vote-btn" onclick="openVote()">VOTAR ‚öñÔ∏è</button>
            </div>

            <div id="chat-box"></div>
            
            <div id="input-area" style="display: flex; gap: 5px;">
                <input type="text" id="chat-input" placeholder="Escreva aqui...">
                <button id="btn-send" onclick="sendMsg()" style="width:80px; background:#f39c12;">ENVIAR</button>
            </div>

            <div id="replay-section" style="display:none; margin-top: 10px;">
                <button onclick="location.reload()" style="background: #27ae60;">SAIR / NOVA SALA</button>
            </div>
        </div>
    </div>

<script>
    let peer = new Peer(), conn, myId, isHost = false, amIImpostor = false;
    let roomPass = "", players = [], maxPlayers = 3, gameMode = "turno", turnIndex = 0;
    let words = ["TABLET", "CAF√â", "TELEVIS√ÉO", "PIZZA", "CELULAR", "GELADEIRA", "FOGO", "CARRO", "SAPATO", "BOLO", "XBOX"];
    let currentWord = "", turnTimer, votes = {}, allPlayers = [];

    peer.on('open', id => {
        myId = id;
        // Checar se entrou via link
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('room')) document.getElementById('join-id').value = urlParams.get('room');
    });

    function setupHost() {
        const p = prompt("Crie uma senha para a sala:"); if(!p) return;
        roomPass = p; isHost = true;
        maxPlayers = parseInt(document.getElementById('max-players').value);
        gameMode = document.getElementById('game-mode').value;
        
        document.getElementById('display-id').innerText = myId;
        document.getElementById('room-info').style.display = 'block';
        showScreen('game-screen');
        
        peer.on('connection', c => {
            c.on('data', data => {
                if(data.type === 'auth') {
                    if(data.pass === roomPass && players.length < maxPlayers - 1) {
                        players.push({id: c.peer, name: data.name, conn: c});
                        c.send({type: 'auth_ok', max: maxPlayers, mode: gameMode});
                        addMsg("SISTEMA", data.name + " entrou!");
                        updateLobby();
                        if(players.length === maxPlayers - 1) startGame();
                    } else c.send({type: 'auth_fail'});
                }
                if(data.type === 'chat') handleIncomingChat(data);
                if(data.type === 'guess') checkGuess(data.word, data.name);
                if(data.type === 'vote_cast') handleVoteCast(data.target, data.voter);
            });
        });
    }

    function joinRoom() {
        const hId = document.getElementById('join-id').value;
        const ps = document.getElementById('join-pass').value;
        const n = document.getElementById('player-name').value || "Jogador";
        conn = peer.connect(hId);
        conn.on('open', () => conn.send({type: 'auth', pass: ps, name: n}));
        conn.on('data', data => {
            if(data.type === 'auth_ok') { maxPlayers = data.max; gameMode = data.mode; showScreen('game-screen'); }
            if(data.type === 'start') handleStart(data);
            if(data.type === 'chat') addMsg(data.name, data.text);
            if(data.type === 'turn') updateTurnUI(data.name);
            if(data.type === 'end') endGame(data.msg);
        });
    }

    function startGame() {
        currentWord = words[Math.floor(Math.random()*words.length)];
        const impIdx = Math.floor(Math.random() * maxPlayers);
        allPlayers = [{id: myId, name: document.getElementById('player-name').value, isImp: (impIdx === 0)}, 
                      ...players.map((p, i) => ({id: p.id, name: p.name, isImp: (impIdx === i+1)}))];
        
        players.forEach((p, i) => {
            p.conn.send({type: 'start', isImp: (impIdx === i+1), word: currentWord, all: allPlayers});
        });
        handleStart({isImp: (impIdx === 0), word: currentWord, all: allPlayers});
    }

    function handleStart(data) {
        amIImpostor = data.isImp; currentWord = data.word; allPlayers = data.all; votes = {};
        const d = document.getElementById('role-display');
        d.innerText = amIImpostor ? "VOC√ä √â O IMPOSTOR!" : "PALAVRA: " + currentWord;
        d.style.background = amIImpostor ? "#e74c3c" : "#27ae60";
        document.getElementById('btn-guess').style.display = amIImpostor ? "block" : "none";
        document.getElementById('btn-vote').disabled = false;
        
        if(gameMode === 'turno') { turnIndex = 0; if(isHost) startTurnCycle(); }
        else { document.getElementById('timer-display').innerText = "LIVRE"; document.getElementById('btn-send').disabled = false; }
    }

    function sendMsg() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(!text) return;
        const name = document.getElementById('player-name').value || "Anon";
        
        if(isHost) { handleIncomingChat({name, text}); } 
        else { conn.send({type: 'chat', name, text}); }
        
        input.value = ""; // LIMPA O CHAT AO ENVIAR
        if(gameMode === 'turno') hideMarquee();
    }

    function handleIncomingChat(data) {
        addMsg(data.name, data.text);
        if(isHost) {
            players.forEach(p => p.conn.send({type: 'chat', name: data.name, text: data.text}));
            if(gameMode === 'turno') nextTurn();
        }
    }

    function openVote() {
        let options = allPlayers.map(p => p.name);
        let target = prompt("QUEM √â O IMPOSTOR? \n" + options.join(", "));
        if(!target) return;
        const found = allPlayers.find(p => p.name.toUpperCase() === target.toUpperCase());
        if(found) {
            if(isHost) handleVoteCast(found.name, "Host");
            else conn.send({type: 'vote_cast', target: found.name, voter: document.getElementById('player-name').value});
            document.getElementById('btn-vote').disabled = true;
        }
    }

    function handleVoteCast(target, voter) {
        addMsg("VOTO", `${voter} votou em ${target}`);
        votes[target] = (votes[target] || 0) + 1;
        const majority = Math.ceil(maxPlayers / 2);
        if(votes[target] >= (maxPlayers === 2 ? 1 : majority)) {
            const playerObj = allPlayers.find(p => p.name === target);
            if(playerObj.isImp) relayEnd(`VIT√ìRIA! ${target} era o IMPOSTOR! üî™`);
            else relayEnd(`DERROTA! ${target} era INOCENTE! O impostor venceu.`);
        }
    }

    function checkGuess(g, name) {
        if(g.toUpperCase().includes(currentWord)) relayEnd(`O IMPOSTOR (${name}) DESCOBRIU! Era ${currentWord}!`);
        else relayEnd(`O IMPOSTOR (${name}) ERROU! Era ${currentWord}!`);
    }

    function relayEnd(msg) {
        endGame(msg);
        if(isHost) players.forEach(p => p.conn.send({type: 'end', msg}));
    }

    function endGame(msg) {
        clearInterval(turnTimer); hideMarquee();
        addMsg("FIM", msg);
        document.getElementById('replay-section').style.display = 'block';
        document.getElementById('status-msg').innerText = "FIM DE JOGO";
    }

    function startTurnCycle() {
        const p = allPlayers[turnIndex];
        if(isHost) players.forEach(c => c.conn.send({type: 'turn', name: p.name}));
        updateTurnUI(p.name);
        let time = 20; clearInterval(turnTimer);
        turnTimer = setInterval(() => {
            time--; document.getElementById('timer-display').innerText = time;
            if(time <= 7) showMarquee(p.name);
            if(time <= 0) { clearInterval(turnTimer); nextTurn(); }
        }, 1000);
    }

    function nextTurn() { turnIndex = (turnIndex + 1) % maxPlayers; startTurnCycle(); }

    function updateTurnUI(name) {
        const isMyTurn = (name === document.getElementById('player-name').value);
        document.getElementById('status-msg').innerText = isMyTurn ? "SUA VEZ!" : "Vez de: " + name;
        document.getElementById('btn-send').disabled = !isMyTurn;
    }

    function addMsg(n, t) {
        const b = document.getElementById('chat-box');
        b.innerHTML += `<div class="msg"><b>${n}:</b> ${t}</div>`;
        b.scrollTop = b.scrollHeight;
    }

    function showMarquee(name) { document.getElementById('marquee-container').style.display = 'block'; document.getElementById('marquee-val').innerText = `${name.toUpperCase()} ANDA LOGO! O TEMPO EST√Å ACABANDO!`; }
    function hideMarquee() { document.getElementById('marquee-container').style.display = 'none'; }
    function showScreen(s) { document.querySelectorAll('.screen').forEach(d => d.classList.remove('active')); document.getElementById(s).classList.add('active'); }
    function updateLobby() { document.getElementById('status-msg').innerText = `Jogadores: ${players.length+1}/${maxPlayers}`; }
    
    function copyInviteLink() {
        const link = window.location.href.split('?')[0] + "?room=" + myId;
        navigator.clipboard.writeText(link);
        alert("Link de convite copiado! Mande para seu amigo.");
    }
    
    function impostorGuess() {
        const g = prompt("Qual √© a palavra?");
        if(!g) return;
        if(isHost) checkGuess(g, "Voc√™"); else conn.send({type: 'guess', word: g, name: document.getElementById('player-name').value});
    }
</script>
</body>
</html>
