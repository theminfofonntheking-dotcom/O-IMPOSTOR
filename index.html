<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>O IMPOSTOR üî™ VOICE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0f0f1a; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-container { background: #1c1c2d; width: 95%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.7); border: 2px solid #3b3b55; position: relative; box-sizing: border-box; }
        .active { display: block !important; }
        .screen { display: none; }
        
        #marquee-container { width: 100%; overflow: hidden; background: #e74c3c; color: white; position: absolute; top: 0; left: 0; border-radius: 20px 20px 0 0; display: none; padding: 5px 0; z-index: 10; }
        .marquee-text { display: inline-block; white-space: nowrap; animation: marquee 8s linear infinite; font-weight: bold; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; background: #2a2a40; color: #fff; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; background: #7289da; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        #voice-status { background: #43b581; font-size: 10px; padding: 5px; border-radius: 5px; text-align: center; margin-bottom: 10px; display: none; }
        #timer-display { font-size: 28px; text-align: center; color: #f39c12; font-weight: bold; }
        #status-msg { text-align: center; color: #43b581; margin-bottom: 5px; font-weight: bold; }
        #chat-box { height: 180px; overflow-y: auto; background: #0f0f1a; padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid #3b3b55; }
        .msg { margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px; font-size: 14px; }
        .action-btns { display: flex; gap: 5px; }
        button.imp-btn { background: #e74c3c; flex: 1; font-size: 12px; }
        button.vote-btn { background: #f1c40f; color: #000; flex: 1; font-size: 12px; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="marquee-container"><div class="marquee-text" id="marquee-val">JOGADOR DEMORANDO! ANDA LOGO!</div></div>

        <div id="setup-screen" class="screen active">
            <h1 style="text-align: center; color: #e74c3c; margin: 0 0 10px 0;">O IMPOSTOR üî™</h1>
            <input type="text" id="player-name" placeholder="Seu Nome" maxlength="20">
            
            <div style="background: #2a2a40; padding: 10px; border-radius: 10px; margin: 5px 0;">
                <label style="font-size: 11px; color: #888;">JOGADORES:</label>
                <select id="max-players"><option value="2">2 (X1)</option><option value="3" selected>3 Jogadores</option></select>
                <label style="font-size: 11px; color: #888;">MODO:</label>
                <select id="game-mode"><option value="turno">TURNO + VOZ</option><option value="livre">LIVRE + VOZ</option></select>
            </div>

            <button onclick="setupHost()" style="background:#43b581">CRIAR SALA</button>
            <input type="text" id="join-id" placeholder="ID da Sala">
            <input type="password" id="join-pass" placeholder="Senha">
            <button onclick="joinRoom()">ENTRAR</button>
        </div>

        <div id="game-screen" class="screen">
            <div id="voice-status">üé§ VOZ ATIVA</div>
            <div id="timer-display">--</div>
            <div id="status-msg">Iniciando...</div>
            
            <div class="action-btns">
                <button id="btn-guess" class="imp-btn" onclick="impostorGuess()" style="display:none;">ADIVINHAR üí°</button>
                <button id="btn-vote" class="vote-btn" onclick="openVote()">VOTAR ‚öñÔ∏è</button>
            </div>

            <div id="chat-box"></div>
            
            <div id="input-area" style="display: flex; gap: 5px;">
                <input type="text" id="chat-input" placeholder="Chat...">
                <button id="btn-send" onclick="sendMsg()" style="width:70px; background:#f39c12;">OK</button>
            </div>
            
            <button id="copy-btn" style="background: #555; font-size: 10px;" onclick="copyInviteLink()">üìã LINK DE CONVITE</button>
            <button onclick="location.reload()" style="background: #222; font-size: 10px;">SAIR</button>
        </div>
    </div>

<script>
    let peer = new Peer(), conn, myId, isHost = false, amIImpostor = false;
    let players = [], maxPlayers = 3, gameMode = "turno", turnIndex = 0;
    let words = ["TABLET", "CAF√â", "TELEVIS√ÉO", "PIZZA", "CELULAR", "GELADEIRA", "FOGO", "CARRO", "SAPATO", "BOLO"];
    let currentWord = "", turnTimer, allPlayers = [], myStream;

    peer.on('open', id => {
        myId = id;
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('room')) document.getElementById('join-id').value = urlParams.get('room');
    });

    // Fun√ß√£o para capturar √°udio
    async function initVoice() {
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            document.getElementById('voice-status').style.display = 'block';
            
            // Ouvir chamadas de voz
            peer.on('call', call => {
                call.answer(myStream);
                call.on('stream', remoteStream => playStream(remoteStream));
            });
        } catch (e) { alert("Ative o Microfone para jogar com Voz!"); }
    }

    function playStream(stream) {
        const audio = new Audio();
        audio.srcObject = stream;
        audio.play();
    }

    async function setupHost() {
        const p = prompt("Senha:"); if(!p) return;
        await initVoice();
        isHost = true;
        maxPlayers = parseInt(document.getElementById('max-players').value);
        gameMode = document.getElementById('game-mode').value;
        showScreen('game-screen');
        
        peer.on('connection', c => {
            c.on('data', data => {
                if(data.type === 'auth') {
                    players.push({id: c.peer, name: data.name, conn: c});
                    c.send({type: 'auth_ok', max: maxPlayers, mode: gameMode});
                    // Ligar para o novo jogador
                    peer.call(c.peer, myStream);
                    if(players.length === maxPlayers - 1) startGame();
                }
                if(data.type === 'chat') handleIncomingChat(data);
                if(data.type === 'guess') checkGuess(data.word, data.name);
                if(data.type === 'vote_cast') handleVoteCast(data.target, data.voter);
            });
        });
    }

    async function joinRoom() {
        const hId = document.getElementById('join-id').value;
        await initVoice();
        conn = peer.connect(hId);
        conn.on('open', () => conn.send({type: 'auth', name: document.getElementById('player-name').value}));
        conn.on('data', data => {
            if(data.type === 'auth_ok') { maxPlayers = data.max; gameMode = data.mode; showScreen('game-screen'); }
            if(data.type === 'start') handleStart(data);
            if(data.type === 'chat') addMsg(data.name, data.text);
            if(data.type === 'turn') updateTurnUI(data.name);
            if(data.type === 'end') alert(data.msg);
        });
    }

    // --- L√ìGICA DO JOGO ---
    function startGame() {
        currentWord = words[Math.floor(Math.random()*words.length)];
        const impIdx = Math.floor(Math.random() * maxPlayers);
        allPlayers = [{id: myId, name: document.getElementById('player-name').value, isImp: (impIdx === 0)}, ...players.map((p, i) => ({id: p.id, name: p.name, isImp: (impIdx === i+1)}))];
        players.forEach((p, i) => p.conn.send({type: 'start', isImp: (impIdx === i+1), word: currentWord, all: allPlayers}));
        handleStart({isImp: (impIdx === 0), word: currentWord, all: allPlayers});
    }

    function handleStart(data) {
        amIImpostor = data.isImp; currentWord = data.word; allPlayers = data.all;
        document.getElementById('status-msg').innerText = amIImpostor ? "VOC√ä √â O IMPOSTOR!" : "PALAVRA: " + currentWord;
        document.getElementById('btn-guess').style.display = amIImpostor ? "block" : "none";
        if(gameMode === 'turno') { turnIndex = 0; if(isHost) startTurnCycle(); }
        else { document.getElementById('timer-display').innerText = "VOZ LIVRE"; }
    }

    function sendMsg() {
        const i = document.getElementById('chat-input'); if(!i.value) return;
        const name = document.getElementById('player-name').value;
        if(isHost) handleIncomingChat({name, text: i.value}); else conn.send({type: 'chat', name, text: i.value});
        i.value = "";
    }

    function handleIncomingChat(data) {
        addMsg(data.name, data.text);
        if(isHost) { players.forEach(p => p.conn.send({type: 'chat', name: data.name, text: data.text})); if(gameMode === 'turno') nextTurn(); }
    }

    function startTurnCycle() {
        const p = allPlayers[turnIndex];
        if(isHost) players.forEach(c => c.conn.send({type: 'turn', name: p.name}));
        updateTurnUI(p.name);
        let time = 20; clearInterval(turnTimer);
        turnTimer = setInterval(() => {
            time--; document.getElementById('timer-display').innerText = time;
            if(time <= 0) nextTurn();
        }, 1000);
    }

    function nextTurn() { if(!isHost) return; turnIndex = (turnIndex + 1) % maxPlayers; startTurnCycle(); }

    function updateTurnUI(name) {
        const isMyTurn = (name === document.getElementById('player-name').value);
        document.getElementById('status-msg').innerText = isMyTurn ? "FALE AGORA! üé§" : "Ouvindo: " + name;
        document.getElementById('btn-send').disabled = !isMyTurn;
    }

    function addMsg(n, t) { const b = document.getElementById('chat-box'); b.innerHTML += `<div class="msg"><b>${n}:</b> ${t}</div>`; b.scrollTop = b.scrollHeight; }
    function showScreen(s) { document.querySelectorAll('.screen').forEach(d => d.classList.remove('active')); document.getElementById(s).classList.add('active'); }
    function copyInviteLink() { navigator.clipboard.writeText(window.location.href.split('?')[0] + "?room=" + myId); alert("Link de Voz copiado!"); }
    
    function impostorGuess() {
        const g = prompt("A palavra √©:");
        if(!g) return;
        if(isHost) checkGuess(g, "Impostor"); else conn.send({type: 'guess', word: g, name: document.getElementById('player-name').value});
    }

    function checkGuess(g, name) {
        const win = g.toUpperCase().includes(currentWord);
        const msg = win ? `O IMPOSTOR GANHOU! A palavra era ${currentWord}` : `IMPOSTOR ERROU! Inocentes venceram!`;
        if(isHost) players.forEach(p => p.conn.send({type: 'end', msg}));
        alert(msg); location.reload();
    }

    function openVote() {
        let t = prompt("Nome de quem quer expulsar:");
        if(!t) return;
        if(isHost) handleVoteCast(t, "Host"); else conn.send({type: 'vote_cast', target: t, voter: document.getElementById('player-name').value});
    }

    function handleVoteCast(t, v) {
        addMsg("VOTO", v + " votou em " + t);
        // Simples: em 2 ou 3 players, o host decide o fim por enquanto ou adiciona contagem
    }
</script>
</body>
</html>
